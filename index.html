<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generator Podpisów by artystek</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&family=Nothing+You+Could+Do&family=Mrs+Saint+Delafield&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --bg-color: #eef2f3;
            --accent-color: #3498db;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .main-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
            padding-bottom: 20px;
        }

        /* --- LEWY PANEL (Kontrolki) --- */
        .controls-panel {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: fit-content;
        }

        h3 { margin: 5px 0 10px 0; color: var(--primary-color); border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; font-size: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .control-group { margin-bottom: 5px; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; margin-bottom: 6px; }
        
        input[type="text"], select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        
        input[type="range"] { 
            width: 100%; cursor: pointer; margin: 10px 0; 
            height: 20px;
        }

        .tabs { display: flex; gap: 8px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 10px; border: 1px solid #ddd; background: #f9f9f9;
            cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 14px;
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .mode-content { display: none; }
        .mode-content.active { display: block; }

        .btn-action {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px;
            transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-green { background: #27ae60; color: white; }
        .btn-green:hover { background: #219150; transform: translateY(-1px); }
        .btn-red { background: #e74c3c; color: white; font-size: 12px; padding: 8px 12px; border-radius: 4px; width: auto;}

        /* --- PRAWY PANEL (Podgląd) --- */
        .preview-area {
            flex: 1;
            min-width: 320px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
        }

        #paper-sheet {
            background-color: #fff;
            position: relative;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            display: inline-block; 
            min-width: 280px;
            transition: box-shadow 0.3s, background 0.3s;
        }

        .transparent-mode {
            background-color: transparent !important;
            background-image: none !important;
            box-shadow: none !important;
            border: none !important;
        }

        .signature-block {
            position: relative;
            text-align: center;
            width: 300px;
            margin: 0 auto;
            /* Flexbox dla lepszego centrowania przy zawijaniu tekstu */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dotted-line {
            border-bottom: 2px dotted #333;
            width: 100%;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .role-display {
            font-family: 'Courier Prime', monospace;
            font-size: 13px; color: #333;
            text-transform: uppercase; letter-spacing: 1px;
            /* Zmiana: Obsługa długiego tekstu */
            white-space: normal;
            word-wrap: break-word;
            width: 100%;
            line-height: 1.2;
            position: relative; /* Dla przesuwania */
        }

        .sig-wrapper {
            position: relative;
            min-height: 80px; /* Zmiana z height na min-height */
            width: 100%;
            display: flex; 
            justify-content: center; 
            align-items: flex-end;
            margin-bottom: 5px;
        }

        .generated-sig {
            font-size: 40px; 
            line-height: 0.8; /* Mniejsza interlinia dla wielowierszowych podpisów */
            /* Zmiana: Obsługa długiego tekstu */
            white-space: normal;
            word-break: break-word;
            text-align: center;
            width: 100%;
            
            transform-origin: center bottom;
            mix-blend-mode: multiply;
        }

        #drawingCanvas {
            mix-blend-mode: multiply;
            touch-action: none;
        }
        
        .canvas-helper {
            border: 1px dashed rgba(52, 152, 219, 0.4);
            background: rgba(52, 152, 219, 0.03);
        }

        /* --- PIECZĘĆ --- */
        .stamp-container {
            position: absolute;
            width: 120px; height: 120px;
            z-index: 100;
            cursor: move;
            user-select: none;
            left: -30px; top: 10px;
            display: flex; justify-content: center; align-items: center;
            mix-blend-mode: multiply;
            transform: rotate(-15deg);
        }
        
        .stamp-container:active { opacity: 0.7; transform: rotate(-15deg) scale(1.05); }

        .css-stamp {
            width: 100%; height: 100%;
            border: 3px double #c0392b; border-radius: 50%; color: #c0392b;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier Prime', monospace; font-size: 11px; font-weight: bold;
            text-align: center; background: rgba(255,255,255,0.1);
        }
        .css-stamp span { border: 2px solid #c0392b; padding: 10px 2px; width: 90%; display: block; }
        
        .stamp-img-custom { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        
        .drag-hint {
            position: absolute; top: -25px; left: 0; right: 0;
            font-size: 10px; background: #333; color: #fff;
            padding: 4px; border-radius: 4px; display: none; text-align: center;
        }
        .stamp-container:hover .drag-hint { display: block; }

        /* --- STYLIZACJA CHECKBOXÓW --- */
        .bg-options { display: flex; gap: 10px; margin-top: 5px; }
        .bg-option {
            flex: 1; display: flex; align-items: center; gap: 5px;
            padding: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .bg-option:hover { background: #f5f5f5; }
        .bg-option input { margin: 0; }


        /* --- RESPONSYWNOŚĆ (Mobile) --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .main-wrapper { gap: 10px; }
            
            .controls-panel {
                min-width: 100%; width: 100%;
                padding: 15px; order: 2;
            }
            
            .preview-area {
                min-width: 100%; width: 100%;
                padding: 5px;
                order: 1;
                background: #e0e5e8;
                border-radius: 8px;
                overflow-x: auto;
            }

            #paper-sheet {
                max-width: 100%; 
                min-width: auto;
                box-sizing: border-box;
            }

            .signature-block {
                width: 100% !important;
                max-width: 320px;
            }
            
            .hide-mobile { display: none; }
            
            h3 { font-size: 15px; }
            .btn-action { position: sticky; bottom: 10px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        }
    </style>
</head>
<body>

<div class="main-wrapper">

    <div class="preview-area">
        <div id="paper-sheet">
            <div class="signature-block" id="sigBlock">
                
                <div class="stamp-container" id="draggableStamp">
                    <div class="drag-hint">Chwyć i przesuń</div>
                    <div id="stampInner" class="css-stamp">
                        <span>ZATWIERDZONO<br>ORYGINAŁ</span>
                    </div>
                </div>

                <div class="sig-wrapper" id="sigWrapper">
                    <div id="textSig" class="generated-sig">Jan Kowalski</div>
                    <canvas id="drawingCanvas" width="300" height="100" style="display:none;"></canvas>
                </div>

                <div class="dotted-line"></div>
                <div class="role-display" id="roleDisplay">Główny Księgowy</div>

            </div>
        </div>
    </div>

    <div class="controls-panel">
        
        <h3>1. Ustawienia Pliku</h3>
        <div class="bg-options">
            <label class="bg-option">
                <input type="radio" name="bgType" value="white" checked>
                Tło Białe
            </label>
            <label class="bg-option">
                <input type="radio" name="bgType" value="transparent">
                Tło Przeźroczyste
            </label>
        </div>

        <h3>2. Treść Podpisu</h3>
        <div class="tabs">
            <button class="tab-btn active" onclick="setMode('type')" id="btnType">Klawiatura</button>
            <button class="tab-btn" onclick="setMode('draw')" id="btnDraw">Rysowanie</button>
        </div>

        <div id="modeType" class="mode-content active">
            <input type="text" id="nameInput" value="Jan Kowalski" oninput="updateContent()">
            <select id="fontSelect" onchange="updateContent()" style="margin-top:8px;">
                <option value="'Nothing You Could Do', cursive">Styl 1: Szybki</option>
                <option value="'Mrs Saint Delafield', cursive">Styl 2: Elegancki</option>
            </select>
        </div>

        <div id="modeDraw" class="mode-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <label style="margin:0">Grubość linii:</label>
                <button class="btn-red" onclick="clearCanvas()">Wyczyść</button>
            </div>
            <input type="range" id="penSize" min="1" max="5" value="2">
        </div>

        <div class="control-group">
            <label>Kolor tuszu:</label>
            <select id="colorSelect" onchange="updateColors()">
                <option value="#000080">Granatowy</option>
                <option value="#000000">Czarny</option>
                <option value="#006400">Zielony</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Pozycja Podpisu (X / Y):</label>
            <div style="display:flex; gap:10px;">
                 <input type="range" min="-50" max="50" value="0" oninput="adjustSignatureLayout()" id="sigXRange">
                 <input type="range" min="-50" max="50" value="0" oninput="adjustSignatureLayout()" id="sigYRange">
            </div>
        </div>

        <h3>3. Stanowisko</h3>
        <div class="control-group">
            <input type="text" id="roleInput" placeholder="Stanowisko" value="Główny Księgowy" oninput="updateContent()">
        </div>
        <div class="control-group">
            <label>Rozmiar czcionki:</label>
            <input type="range" min="8" max="20" value="13" oninput="adjustRoleLayout()" id="roleSizeRange">
        </div>
        <div class="control-group">
            <label>Pozycja Stanowiska (X / Y):</label>
            <div style="display:flex; gap:10px;">
                 <input type="range" min="-50" max="50" value="0" oninput="adjustRoleLayout()" id="roleXRange">
                 <input type="range" min="-30" max="30" value="0" oninput="adjustRoleLayout()" id="roleYRange">
            </div>
        </div>


        <h3>4. Pieczęć i Blok</h3>
        <input type="file" id="stampUpload" accept="image/*" style="font-size:12px; margin-bottom:10px;">
        <div style="font-size:13px; display:flex; flex-wrap:wrap; gap:15px; margin-bottom:10px;">
            <label style="display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="bwCheck" onchange="processStampImage()"> 
                Czarno-biała
            </label>
            <label style="display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="noStampCheck" onchange="toggleStamp()"> 
                Ukryj
            </label>
        </div>
        
        <div class="control-group hide-mobile">
            <label>Szerokość bloku:</label>
            <input type="range" min="200" max="500" value="300" oninput="adjustBlockWidth()" id="widthRange">
        </div>
        <h5>Made by artystek for BCSO DarkCity</h5>
        <button class="btn-action btn-green" onclick="downloadPNG()">⬇ POBIERZ PNG</button>
    </div>

</div>

<script>
    // --- ZMIENNE ---
    let mode = 'type';
    const sigBlock = document.getElementById('sigBlock');
    const textSig = document.getElementById('textSig');
    const roleDisplay = document.getElementById('roleDisplay');
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const stampDiv = document.getElementById('draggableStamp');
    const stampInner = document.getElementById('stampInner');
    let originalStampSrc = null;

    // --- 1. TREŚĆ I KOLORY ---
    function updateContent() {
        roleDisplay.textContent = document.getElementById('roleInput').value;
        textSig.textContent = document.getElementById('nameInput').value;
        textSig.style.fontFamily = document.getElementById('fontSelect').value;
    }

    function updateColors() {
        const color = document.getElementById('colorSelect').value;
        textSig.style.color = color;
        textSig.style.textShadow = `0 0 1px ${color}`;
        ctx.strokeStyle = color;
    }

    // --- 2. TRYBY ---
    function setMode(newMode) {
        mode = newMode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
        
        if(mode === 'type') {
            document.getElementById('btnType').classList.add('active');
            document.getElementById('modeType').classList.add('active');
            textSig.style.display = 'block';
            canvas.style.display = 'none';
        } else {
            document.getElementById('btnDraw').classList.add('active');
            document.getElementById('modeDraw').classList.add('active');
            textSig.style.display = 'none';
            canvas.style.display = 'block';
            canvas.classList.add('canvas-helper');
            ctx.strokeStyle = document.getElementById('colorSelect').value;
        }
        adjustSignatureLayout(); // Odśwież pozycję po zmianie trybu
    }

    // --- 3. POZYCJONOWANIE (Nowe funkcje) ---
    function adjustBlockWidth() {
        if (window.innerWidth > 768) {
            const width = document.getElementById('widthRange').value;
            sigBlock.style.width = width + 'px';
        } else {
            sigBlock.style.width = '100%';
        }
    }

    function adjustSignatureLayout() {
        const x = document.getElementById('sigXRange').value;
        const y = document.getElementById('sigYRange').value;
        const target = mode === 'type' ? textSig : canvas;
        
        // Dla trybu pisania dodajemy lekką rotację dla realizmu
        const rotate = mode === 'type' ? -3 : 0;
        target.style.transform = `translate(${x}px, ${y}px) rotate(${rotate}deg)`;
    }

    function adjustRoleLayout() {
        const x = document.getElementById('roleXRange').value;
        const y = document.getElementById('roleYRange').value;
        const size = document.getElementById('roleSizeRange').value;
        
        roleDisplay.style.transform = `translate(${x}px, ${y}px)`;
        roleDisplay.style.fontSize = size + 'px';
    }

    // --- 4. DRAG & DROP PIECZĘCI ---
    let isDragging = false;
    let offset = { x: 0, y: 0 };

    stampDiv.addEventListener('mousedown', startDrag);
    stampDiv.addEventListener('touchstart', startDrag, {passive: false});

    function startDrag(e) {
        isDragging = true;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        offset.x = clientX - stampDiv.getBoundingClientRect().left;
        offset.y = clientY - stampDiv.getBoundingClientRect().top;
        stampDiv.style.cursor = 'grabbing';
    }

    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchmove', moveDrag, {passive: false});

    function moveDrag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const parentRect = sigBlock.getBoundingClientRect();
        
        let newLeft = clientX - parentRect.left - offset.x;
        let newTop = clientY - parentRect.top - offset.y;
        
        stampDiv.style.left = newLeft + 'px';
        stampDiv.style.top = newTop + 'px';
    }

    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    function endDrag() { isDragging = false; stampDiv.style.cursor = 'move'; }

    // --- 5. OBSŁUGA PIECZĘCI ---
    document.getElementById('stampUpload').addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                originalStampSrc = evt.target.result;
                processStampImage();
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    function processStampImage() {
        if (!originalStampSrc) return;
        const isBW = document.getElementById('bwCheck').checked;
        const img = new Image();
        img.src = originalStampSrc;

        img.onload = () => {
            if (isBW) {
                const tempCanvas = document.createElement('canvas');
                const tCtx = tempCanvas.getContext('2d');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                tCtx.drawImage(img, 0, 0);
                const imgData = tCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imgData.data;

                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const contrast = avg > 120 ? 255 : avg * 0.5;
                    data[i] = contrast; data[i + 1] = contrast; data[i + 2] = contrast;
                }
                tCtx.putImageData(imgData, 0, 0);
                stampInner.innerHTML = `<img src="${tempCanvas.toDataURL()}" class="stamp-img-custom">`;
            } else {
                stampInner.innerHTML = `<img src="${originalStampSrc}" class="stamp-img-custom">`;
            }
            stampInner.className = '';
        };
    }

    function toggleStamp() {
        const hide = document.getElementById('noStampCheck').checked;
        stampDiv.style.display = hide ? 'none' : 'flex';
    }

    // --- 6. RYSOWANIE ---
    let drawing = false;
    let lastX = 0, lastY = 0;

    canvas.addEventListener('mousedown', (e) => { drawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);

    canvas.addEventListener('touchstart', (e) => {
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.touches[0].clientX - rect.left;
        lastY = e.touches[0].clientY - rect.top;
        e.preventDefault();
    });
    canvas.addEventListener('touchmove', (e) => {
        if(!drawing) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const y = e.touches[0].clientY - rect.top;
        drawStroke(x, y);
    });

    function drawLine(e) { if(drawing) drawStroke(e.offsetX, e.offsetY); }
    function drawStroke(x, y) {
        ctx.lineJoin = 'round'; ctx.lineCap = 'round';
        ctx.lineWidth = document.getElementById('penSize').value;
        ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
        [lastX, lastY] = [x, y];
    }
    function clearCanvas() { ctx.clearRect(0,0,canvas.width, canvas.height); }

    // --- 7. POBIERANIE ---
    function downloadPNG() {
        const element = document.getElementById('paper-sheet');
        const bgType = document.querySelector('input[name="bgType"]:checked').value;
        
        if(mode === 'draw') canvas.classList.remove('canvas-helper');
        
        if (bgType === 'transparent') {
            element.classList.add('transparent-mode');
        }

        html2canvas(element, {
            scale: 3,
            backgroundColor: null
        }).then(c => {
            const link = document.createElement('a');
            link.download = `podpis_${bgType}.png`;
            link.href = c.toDataURL('image/png');
            link.click();
            
            if(mode === 'draw') canvas.classList.add('canvas-helper');
            element.classList.remove('transparent-mode');
        });
    }

    // Inicjalizacja
    adjustBlockWidth();
    adjustSignatureLayout();
    adjustRoleLayout();
    
    window.addEventListener('resize', adjustBlockWidth);
</script>

</body>
</html>
