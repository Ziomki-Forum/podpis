<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Podpisów PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&family=Nothing+You+Could+Do&family=Mrs+Saint+Delafield&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --bg-color: #f0f2f5;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 1100px;
            width: 100%;
        }

        /* --- Panel Sterowania --- */
        .controls {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid #eee;
            padding-right: 20px;
        }

        h3 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        label { font-size: 14px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"], select {
            width: 100%; box-sizing: border-box; padding: 8px;
            border: 1px solid #ccc; border-radius: 4px;
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 8px; border: 1px solid #ccc; background: #f9f9f9;
            cursor: pointer; border-radius: 4px; font-weight: bold;
        }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .mode-content { display: none; }
        .mode-content.active { display: block; }

        .file-upload { margin-top: 5px; margin-bottom: 10px; width: 100%; }
        
        .radio-group { display: flex; gap: 15px; font-weight: normal; margin-bottom: 10px; }
        .radio-group label { font-weight: normal; cursor: pointer; display: flex; align-items: center; gap: 5px;}

        .download-btn {
            background-color: #27ae60; color: white; border: none; padding: 15px;
            border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: auto; transition: background 0.2s;
        }
        .download-btn:hover { background-color: #219150; }
        
        .clear-btn {
            background: #e74c3c; color: white; border: none; padding: 5px 10px;
            border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px;
        }

        /* --- Panel Podglądu --- */
        .preview-area {
            flex: 1.5;
            min-width: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #7f8c8d;
            padding: 20px;
            border-radius: 8px;
        }

        #paper-sheet {
            background-color: #fff;
            width: 100%;
            max-width: 550px;
            min-height: 350px;
            position: relative;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            /* Szum papieru */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }

        .signature-block {
            position: relative;
            margin-top: 60px;
            width: 90%;
            margin-left: auto; margin-right: auto;
            text-align: center;
        }

        /* Linia kropkowana */
        .dotted-line {
            border-bottom: 2px dotted #333;
            width: 100%;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .role-display {
            font-family: 'Courier Prime', monospace;
            font-size: 13px;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }

        /* Obszar podpisu (tekst lub canvas) */
        .signature-display-area {
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: flex-end; 
            position: relative;
            z-index: 5; /* Podpis jest niżej niż pieczęć */
            padding-bottom: 2px;
        }

        .generated-sig {
            font-size: 50px;
            line-height: 0.8;
            transform: rotate(-3deg);
            text-shadow: 0 0 1px rgba(0,0,0,0.2); 
            mix-blend-mode: multiply;
        }

        /* STYLIZACJA CANVASA DLA UŻYTKOWNIKA (pomocnicza) */
        .drawing-helper-border {
            border: 2px dashed #3498db; /* Niebieska przerywana linia */
            background-color: rgba(52, 152, 219, 0.05); /* Lekkie tło */
            border-radius: 4px;
        }
        
        #drawingCanvas {
            mix-blend-mode: multiply;
            touch-action: none; /* Blokada przewijania na mobile */
        }

        /* --- PIECZĘĆ --- */
        .stamp-container {
            position: absolute;
            /* Pozycjonowanie względem bloku podpisu */
            left: -30px; 
            bottom: 30px;
            width: 140px;
            height: 140px;
            
            /* WARSTWOWOŚĆ: Najwyżej */
            z-index: 50; 
            
            opacity: 0.9;
            transform: rotate(-15deg);
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Obrazek wgrany przez usera */
        .stamp-img-custom {
            width: 100%; 
            height: 100%; 
            object-fit: contain;
            mix-blend-mode: multiply; /* Usuwa białe tło */
        }

        /* Efekt czarno-białej pieczątki */
        .stamp-effect-bw {
            filter: grayscale(100%) contrast(150%) brightness(0.95);
        }

        /* Domyślna pieczęć CSS */
        .css-stamp {
            width: 100%; height: 100%;
            border: 4px double #d32f2f;
            border-radius: 50%;
            color: #d32f2f;
            display: flex;
            justify-content: center; align-items: center;
            font-weight: bold; font-family: 'Courier Prime', monospace;
            text-align: center; font-size: 12px;
            padding: 10px; box-sizing: border-box;
            background: rgba(255,255,255,0.1); /* lekkie wypełnienie */
            mix-blend-mode: multiply;
        }
        .css-stamp span { border: 2px solid #d32f2f; padding: 15px 2px; border-radius: 2px; display: block; width: 100%; }

    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <h3>Dane pod linią</h3>
        <div>
            <label>Stanowisko / Funkcja:</label>
            <input type="text" id="roleInput" value="Prezes Zarządu" oninput="updateText()">
        </div>

        <h3>Podpis</h3>
        <div class="tabs">
            <button class="tab-btn active" onclick="setMode('type')" id="btnType">Klawiatura</button>
            <button class="tab-btn" onclick="setMode('draw')" id="btnDraw">Rysowanie</button>
        </div>

        <div id="modeType" class="mode-content active">
            <label>Imię i Nazwisko:</label>
            <input type="text" id="nameInput" value="Marek Nowak" oninput="updateText()">
            <label style="margin-top: 10px;">Styl pisma:</label>
            <select id="fontSelect" onchange="updateText()">
                <option value="'Nothing You Could Do', cursive">Szybki (Gryzmoły)</option>
                <option value="'Mrs Saint Delafield', cursive">Elegancki (Kaligrafia)</option>
            </select>
            <label style="margin-top: 10px;">Kolor:</label>
            <select id="colorSelect" onchange="updateColor()">
                <option value="#000099">Niebieski</option>
                <option value="#1a1a1a">Czarny</option>
                <option value="#006400">Zielony</option>
            </select>
        </div>

        <div id="modeDraw" class="mode-content">
            <label>Narysuj podpis w ramce po prawej stronie.</label>
            <button class="clear-btn" onclick="clearCanvas()">Wyczyść pole</button>
            <label style="margin-top: 10px;">Grubość linii:</label>
            <input type="range" id="penSize" min="1" max="5" value="2">
        </div>

        <h3>Pieczęć (Warstwa Wierzchnia)</h3>
        <label>Wgraj plik (JPG/PNG):</label>
        <input type="file" id="stampUpload" accept="image/*" class="file-upload">
        
        <div class="radio-group">
            <label><input type="radio" name="stampStyle" value="original" checked onchange="updateStampStyle()"> Oryginał</label>
            <label><input type="radio" name="stampStyle" value="bw" onchange="updateStampStyle()"> Czarno-biała (Efekt)</label>
        </div>

        <label style="font-size:12px; margin-top:5px;">Lub wybierz domyślną:</label>
        <select id="defaultStampSel" onchange="updateDefaultStamp()">
            <option value="css">Domyślna (CSS)</option>
            <option value="none">Brak pieczęci</option>
        </select>

        <button class="download-btn" onclick="downloadPNG()">⬇ Pobierz Podpis</button>
    </div>

    <div class="preview-area">
        <div id="paper-sheet">
            
            <div class="signature-block">
                
                <div class="stamp-container" id="stampContainer">
                    <div class="css-stamp"><span>ZATWIERDZONO<br>ZARZĄD</span></div>
                </div>

                <div class="signature-display-area">
                    <div id="textSignature" class="generated-sig">Marek Nowak</div>
                    <canvas id="drawingCanvas" width="400" height="150" style="display:none;"></canvas>
                </div>

                <div class="dotted-line"></div>
                <div class="role-display" id="roleDisplay">Prezes Zarządu</div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- Globalne ---
    let currentMode = 'type';
    const textSigDiv = document.getElementById('textSignature');
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const stampContainer = document.getElementById('stampContainer');
    
    // --- Rysowanie (Canvas) ---
    let isDrawing = false;
    let lastX = 0, lastY = 0;

    function initCanvas() {
        // Myszka
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);

        // Dotyk
        canvas.addEventListener('touchstart', (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.touches[0].clientX - rect.left;
            lastY = e.touches[0].clientY - rect.top;
            e.preventDefault();
        });
        canvas.addEventListener('touchmove', (e) => {
            if(!isDrawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            drawStroke(x, y);
        });
    }

    function draw(e) {
        if (!isDrawing) return;
        drawStroke(e.offsetX, e.offsetY);
    }

    function drawStroke(x, y) {
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.lineWidth = document.getElementById('penSize').value;
        ctx.strokeStyle = document.getElementById('colorSelect').value;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        [lastX, lastY] = [x, y];
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- Obsługa Trybów ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));

        if (mode === 'type') {
            document.getElementById('btnType').classList.add('active');
            document.getElementById('modeType').classList.add('active');
            textSigDiv.style.display = 'block';
            canvas.style.display = 'none';
        } else {
            document.getElementById('btnDraw').classList.add('active');
            document.getElementById('modeDraw').classList.add('active');
            textSigDiv.style.display = 'none';
            
            // Włączamy canvas i dodajemy widoczną ramkę edycyjną
            canvas.style.display = 'block';
            canvas.classList.add('drawing-helper-border');
            
            ctx.strokeStyle = document.getElementById('colorSelect').value;
        }
    }

    // --- Aktualizacja Tekstu i Koloru ---
    function updateText() {
        document.getElementById('roleDisplay').textContent = document.getElementById('roleInput').value;
        textSigDiv.textContent = document.getElementById('nameInput').value;
        textSigDiv.style.fontFamily = document.getElementById('fontSelect').value;
    }

    function updateColor() {
        const color = document.getElementById('colorSelect').value;
        textSigDiv.style.color = color;
        textSigDiv.style.textShadow = `0 0 1px ${color}`;
        ctx.strokeStyle = color;
    }

    // --- Obsługa Pieczęci (Wgrywanie + Styl) ---
    const stampInput = document.getElementById('stampUpload');
    const defaultStampSel = document.getElementById('defaultStampSel');

    stampInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Tworzymy obrazek
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'stamp-img-custom';
                img.id = 'uploadedStampImg';
                
                stampContainer.innerHTML = '';
                stampContainer.appendChild(img);
                
                defaultStampSel.value = 'none';
                updateStampStyle(); // Aplikuj styl (org/bw) od razu
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    function updateDefaultStamp() {
        const val = defaultStampSel.value;
        if (val === 'none') {
            stampContainer.innerHTML = '';
            stampInput.value = '';
        } else if (val === 'css') {
            stampContainer.innerHTML = `<div class="css-stamp"><span>ZATWIERDZONO<br>ZARZĄD</span></div>`;
            stampInput.value = '';
        }
    }

    function updateStampStyle() {
        const style = document.querySelector('input[name="stampStyle"]:checked').value;
        const img = document.getElementById('uploadedStampImg');
        
        if (img) {
            if (style === 'bw') {
                img.classList.add('stamp-effect-bw');
            } else {
                img.classList.remove('stamp-effect-bw');
            }
        }
    }

    // --- POBIERANIE (Z usuwaniem ramki) ---
    function downloadPNG() {
        const element = document.getElementById('paper-sheet');
        
        // 1. ZANIM zrobimy zrzut: Usuń ramkę pomocniczą z canvasa
        if (currentMode === 'draw') {
            canvas.classList.remove('drawing-helper-border');
        }

        html2canvas(element, {
            scale: 3,
            backgroundColor: null
        }).then(capturedCanvas => {
            const link = document.createElement('a');
            link.download = 'podpis_pieczec.png';
            link.href = capturedCanvas.toDataURL('image/png');
            link.click();

            // 2. PO zrobieniu zrzutu: Przywróć ramkę, żeby user mógł dalej edytować
            if (currentMode === 'draw') {
                canvas.classList.add('drawing-helper-border');
            }
        });
    }

    // Inicjalizacja
    initCanvas();
    updateColor();
</script>

</body>
</html>
