<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Podpis√≥w: Wersja Finalna</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&family=Nothing+You+Could+Do&family=Mrs+Saint+Delafield&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --bg-color: #eef2f3;
            --accent-color: #3498db;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .main-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
        }

        /* --- LEWY PANEL (Kontrolki) --- */
        .controls-panel {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: fit-content;
        }

        h3 { margin: 0 0 10px 0; color: var(--primary-color); border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; font-size: 18px; }
        
        .control-group { margin-bottom: 5px; }
        label { font-size: 13px; font-weight: bold; color: #666; display: block; margin-bottom: 4px; }
        
        input[type="text"], select {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;
        }

        input[type="range"] { width: 100%; cursor: pointer; }

        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 8px; border: 1px solid #ddd; background: #f9f9f9;
            cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 13px;
        }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .mode-content { display: none; }
        .mode-content.active { display: block; }

        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px;
            transition: 0.2s;
        }
        .btn-green { background: #27ae60; color: white; }
        .btn-green:hover { background: #219150; }
        .btn-red { background: #e74c3c; color: white; font-size: 12px; padding: 6px; width: auto;}

        /* --- PRAWY PANEL (PodglƒÖd) --- */
        .preview-area {
            flex: 2;
            min-width: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #paper-sheet {
            background-color: #fff;
            position: relative;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            display: inline-block; 
            min-width: 250px;
        }

        .signature-block {
            position: relative;
            text-align: center;
            width: 300px;
            margin: 0 auto;
        }

        .dotted-line {
            border-bottom: 2px dotted #333;
            width: 100%;
            margin-top: 5px;
        }

        .role-display {
            font-family: 'Courier Prime', monospace;
            font-size: 13px; color: #333;
            text-transform: uppercase; letter-spacing: 1px;
            margin-top: 5px;
        }

        .sig-wrapper {
            position: relative;
            height: 80px;
            width: 100%;
            display: flex; justify-content: center; align-items: flex-end;
        }

        .generated-sig {
            font-size: 40px; line-height: 1;
            white-space: nowrap;
            transform-origin: center bottom;
            mix-blend-mode: multiply;
        }

        #drawingCanvas {
            mix-blend-mode: multiply;
            touch-action: none;
        }
        
        .canvas-helper {
            border: 1px dashed rgba(52, 152, 219, 0.4);
            background: rgba(52, 152, 219, 0.03);
        }

        /* --- PIECZƒòƒÜ (DRAGGABLE) --- */
        .stamp-container {
            position: absolute;
            width: 120px; height: 120px;
            z-index: 100;
            cursor: move;
            user-select: none;
            left: -40px; top: 10px;
            display: flex; justify-content: center; align-items: center;
            mix-blend-mode: multiply;
            transform: rotate(-15deg);
        }
        
        .stamp-container:active {
            opacity: 0.7;
            transform: rotate(-15deg) scale(1.05);
        }

        .css-stamp {
            width: 100%; height: 100%;
            border: 3px double #c0392b; border-radius: 50%; color: #c0392b;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier Prime', monospace; font-size: 11px; font-weight: bold;
            text-align: center; background: rgba(255,255,255,0.1);
        }
        .css-stamp span { border: 2px solid #c0392b; padding: 10px 2px; width: 90%; display: block; }
        
        .stamp-img-custom { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        
        .drag-hint {
            position: absolute; top: -20px; left: 0; right: 0;
            font-size: 10px; background: #333; color: #fff;
            padding: 2px; border-radius: 3px; display: none;
        }
        .stamp-container:hover .drag-hint { display: block; }

    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="controls-panel">
        <h3>1. Tre≈õƒá</h3>
        <div class="control-group">
            <input type="text" id="roleInput" placeholder="Stanowisko" value="G≈Ç√≥wny Ksiƒôgowy" oninput="updateContent()">
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="setMode('type')" id="btnType">Klawiatura</button>
            <button class="tab-btn" onclick="setMode('draw')" id="btnDraw">Rysowanie</button>
        </div>

        <div id="modeType" class="mode-content active">
            <input type="text" id="nameInput" value="Jan Kowalski" oninput="updateContent()">
            <select id="fontSelect" onchange="updateContent()" style="margin-top:5px;">
                <option value="'Nothing You Could Do', cursive">Styl 1: Szybki</option>
                <option value="'Mrs Saint Delafield', cursive">Styl 2: Elegancki</option>
            </select>
        </div>

        <div id="modeDraw" class="mode-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label>Grubo≈õƒá:</label>
                <button class="btn-red" onclick="clearCanvas()">Wyczy≈õƒá</button>
            </div>
            <input type="range" id="penSize" min="1" max="5" value="2">
        </div>

        <div class="control-group">
            <label>Kolor tuszu:</label>
            <select id="colorSelect" onchange="updateColors()">
                <option value="#000080">Granatowy</option>
                <option value="#000000">Czarny</option>
                <option value="#006400">Zielony</option>
            </select>
        </div>

        <h3>2. Pieczƒôƒá</h3>
        <input type="file" id="stampUpload" accept="image/*" style="font-size:12px;">
        <div style="margin-top:5px; font-size:12px;">
            <label style="display:inline;"><input type="checkbox" id="bwCheck" onchange="processStampImage()"> Czarno-bia≈Ça (Wymu≈õ)</label>
            <label style="display:inline; margin-left:10px;"><input type="checkbox" id="noStampCheck" onchange="toggleStamp()"> Ukryj</label>
        </div>

        <h3>3. Pozycjonowanie (Dopasuj)</h3>
        <div class="control-group">
            <label>Szeroko≈õƒá linii/obszaru:</label>
            <input type="range" min="150" max="500" value="300" oninput="adjustLayout()" id="widthRange">
        </div>
        <div class="control-group">
            <label>Przesuniƒôcie podpisu (G√≥ra/D√≥≈Ç):</label>
            <input type="range" min="-50" max="50" value="0" oninput="adjustLayout()" id="posYRange">
        </div>
        <div class="control-group">
            <label>Przesuniƒôcie podpisu (Lewo/Prawo):</label>
            <input type="range" min="-50" max="50" value="0" oninput="adjustLayout()" id="posXRange">
        </div>
        <p style="font-size:11px; color:#888;">üí° Wskaz√≥wka: Pieczƒôƒá mo≈ºesz przesuwaƒá myszkƒÖ bezpo≈õrednio na obrazku.</p>

        <button class="btn-action btn-green" onclick="downloadPNG()">‚¨á Pobierz (Dopasowany)</button>
    </div>

    <div class="preview-area">
        <div id="paper-sheet">
            
            <div class="signature-block" id="sigBlock">
                
                <div class="stamp-container" id="draggableStamp">
                    <div class="drag-hint">Przesu≈Ñ mnie</div>
                    <div id="stampInner" class="css-stamp">
                        <span>ZATWIERDZONO<br>ORYGINA≈Å</span>
                    </div>
                </div>

                <div class="sig-wrapper" id="sigWrapper">
                    <div id="textSig" class="generated-sig">Jan Kowalski</div>
                    <canvas id="drawingCanvas" width="300" height="100" style="display:none;"></canvas>
                </div>

                <div class="dotted-line"></div>
                <div class="role-display" id="roleDisplay">G≈Ç√≥wny Ksiƒôgowy</div>

            </div>
        </div>
    </div>
</div>

<script>
    // --- ZMIENNE ---
    let mode = 'type';
    const sigBlock = document.getElementById('sigBlock');
    const textSig = document.getElementById('textSig');
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const stampDiv = document.getElementById('draggableStamp');
    const stampInner = document.getElementById('stampInner');
    
    // Zmienne do przechowywania oryginalnej pieczƒôci
    let originalStampSrc = null;

    // --- 1. TRE≈öƒÜ I KOLORY ---
    function updateContent() {
        document.getElementById('roleDisplay').textContent = document.getElementById('roleInput').value;
        textSig.textContent = document.getElementById('nameInput').value;
        textSig.style.fontFamily = document.getElementById('fontSelect').value;
    }

    function updateColors() {
        const color = document.getElementById('colorSelect').value;
        textSig.style.color = color;
        textSig.style.textShadow = `0 0 1px ${color}`;
        ctx.strokeStyle = color;
    }

    // --- 2. TRYBY ---
    function setMode(newMode) {
        mode = newMode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
        
        if(mode === 'type') {
            document.getElementById('btnType').classList.add('active');
            document.getElementById('modeType').classList.add('active');
            textSig.style.display = 'block';
            canvas.style.display = 'none';
        } else {
            document.getElementById('btnDraw').classList.add('active');
            document.getElementById('modeDraw').classList.add('active');
            textSig.style.display = 'none';
            canvas.style.display = 'block';
            canvas.classList.add('canvas-helper');
            ctx.strokeStyle = document.getElementById('colorSelect').value;
        }
    }

    // --- 3. POZYCJONOWANIE ---
    function adjustLayout() {
        const width = document.getElementById('widthRange').value;
        sigBlock.style.width = width + 'px';

        const y = document.getElementById('posYRange').value;
        const x = document.getElementById('posXRange').value;
        const target = mode === 'type' ? textSig : canvas;
        target.style.transform = `translate(${x}px, ${y}px) rotate(${mode === 'type' ? -3 : 0}deg)`;
    }

    // --- 4. DRAG & DROP PIECZƒòCI ---
    let isDragging = false;
    let offset = { x: 0, y: 0 };

    stampDiv.addEventListener('mousedown', startDrag);
    stampDiv.addEventListener('touchstart', startDrag, {passive: false});

    function startDrag(e) {
        isDragging = true;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        offset.x = clientX - stampDiv.getBoundingClientRect().left;
        offset.y = clientY - stampDiv.getBoundingClientRect().top;
        stampDiv.style.cursor = 'grabbing';
    }

    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchmove', moveDrag, {passive: false});

    function moveDrag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const parentRect = sigBlock.getBoundingClientRect();
        let newLeft = clientX - parentRect.left - offset.x;
        let newTop = clientY - parentRect.top - offset.y;
        stampDiv.style.left = newLeft + 'px';
        stampDiv.style.top = newTop + 'px';
    }

    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    function endDrag() { isDragging = false; stampDiv.style.cursor = 'move'; }

    // --- 5. OBS≈ÅUGA PIECZƒòCI (ZAAWANSOWANA KONWERSJA BW) ---
    document.getElementById('stampUpload').addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                originalStampSrc = evt.target.result; // Zapisz orygina≈Ç
                processStampImage(); // Uruchom przetwarzanie
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    function processStampImage() {
        if (!originalStampSrc) return; // Je≈õli nic nie wgrano, nic nie r√≥b

        const isBW = document.getElementById('bwCheck').checked;
        const img = new Image();
        img.src = originalStampSrc;

        img.onload = () => {
            if (isBW) {
                // FIZYCZNA KONWERSJA NA BW (PIKSELE)
                const tempCanvas = document.createElement('canvas');
                const tCtx = tempCanvas.getContext('2d');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                
                tCtx.drawImage(img, 0, 0);
                const imgData = tCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imgData.data;

                // Algorytm szaro≈õci i kontrastu
                for (let i = 0; i < data.length; i += 4) {
                    // ≈örednia jasno≈õƒá
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    // Proste progowanie lub pozostawienie szaro≈õci
                    // Tu robimy szaro≈õƒá + lekki kontrast
                    let gray = avg;
                    
                    data[i] = gray;     // R
                    data[i + 1] = gray; // G
                    data[i + 2] = gray; // B
                    // Alpha (data[i+3]) zostawiamy bez zmian
                }
                tCtx.putImageData(imgData, 0, 0);
                
                // Wstawiamy przerobiony obrazek
                stampInner.innerHTML = `<img src="${tempCanvas.toDataURL()}" class="stamp-img-custom">`;
            } else {
                // Wstawiamy orygina≈Ç
                stampInner.innerHTML = `<img src="${originalStampSrc}" class="stamp-img-custom">`;
            }
            
            stampInner.className = ''; // usuwamy styl CSS ramki
        };
    }

    function toggleStamp() {
        const hide = document.getElementById('noStampCheck').checked;
        stampDiv.style.display = hide ? 'none' : 'flex';
    }

    // --- 6. RYSOWANIE ---
    let drawing = false;
    let lastX = 0, lastY = 0;

    canvas.addEventListener('mousedown', (e) => { drawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
    canvas.addEventListener('mousemove', drawLine);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);

    canvas.addEventListener('touchstart', (e) => {
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.touches[0].clientX - rect.left;
        lastY = e.touches[0].clientY - rect.top;
        e.preventDefault();
    });
    canvas.addEventListener('touchmove', (e) => {
        if(!drawing) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const y = e.touches[0].clientY - rect.top;
        drawStroke(x, y);
    });

    function drawLine(e) { if(drawing) drawStroke(e.offsetX, e.offsetY); }

    function drawStroke(x, y) {
        ctx.lineJoin = 'round'; ctx.lineCap = 'round';
        ctx.lineWidth = document.getElementById('penSize').value;
        ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
        [lastX, lastY] = [x, y];
    }
    function clearCanvas() { ctx.clearRect(0,0,canvas.width, canvas.height); }

    // --- 7. POBIERANIE ---
    function downloadPNG() {
        const element = document.getElementById('paper-sheet');
        if(mode === 'draw') canvas.classList.remove('canvas-helper');

        html2canvas(element, {
            scale: 3,
            backgroundColor: null
        }).then(c => {
            const link = document.createElement('a');
            link.download = 'podpis.png';
            link.href = c.toDataURL('image/png');
            link.click();
            
            if(mode === 'draw') canvas.classList.add('canvas-helper');
        });
    }

    adjustLayout(); 
</script>

</body>
</html>
